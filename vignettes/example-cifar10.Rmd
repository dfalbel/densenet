---
title: "DenseNet for classifying images in cifar10 dataset"
author: "Daniel Falbel"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


In this example we will train a DenseNet to classify images from the CIFAR10
small images dataset.

```{r}
# Libraries ---------------------------------------------------------------
library(keras)
library(densenet)

# Parameters --------------------------------------------------------------

batch_size <- 128
epochs <- 200

# Data Preparation --------------------------------------------------------

# see ?dataset_cifar10 for more info
cifar10 <- dataset_cifar10()

# Normalisation
for(i in 1:3){
  cifar10$train$x[,,,i] <- (cifar10$train$x[,,,i] - mean(cifar10$train$x[,,,i])) / sd(cifar10$train$x[,,,i])
  cifar10$test$x[,,,i] <- (cifar10$test$x[,,,i] - mean(cifar10$train$x[,,,i])) / sd(cifar10$train$x[,,,i])
}
x_train <- cifar10$train$x
x_test <- cifar10$test$x

y_train <- to_categorical(cifar10$train$y, num_classes = 10)
y_test <- to_categorical(cifar10$test$y, num_classes = 10)

# Create image generator --------------------------------------------------

datagen <- image_data_generator(
    featurewise_center = TRUE,
    featurewise_std_normalization = TRUE,
    rotation_range = 20,
    width_shift_range = 0.2,
    height_shift_range = 0.2,
    horizontal_flip = TRUE
  )

datagen %>% fit_image_data_generator(x_train)

# Model Definition -------------------------------------------------------

model <- densenet(
  nb_classes = 10, 
  img_dim = c(32, 32, 3), 
  depth = 22, 
  nb_dense_block = 3, 
  growth_rate = 12,
  nb_filter = 16,
  dropout_rate = 0.2, 
  weight_decay = 1E-4
)

opt <- optimizer_adam(
  lr = 1e-3, 
  beta_1 = 0.9, 
  beta_2 = 0.999, 
  epsilon = 1e-08
)

model %>% compile(
  optimizer = opt,
  loss = "categorical_crossentropy",
  metrics = "accuracy"
)

# Model fitting -----------------------------------------------------------

model %>% fit_generator(
  flow_images_from_data(x_train, y_train, datagen, batch_size = batch_size),
  steps_per_epoch = as.integer(50000/batch_size), 
  epochs = epochs, 
  validation_data = list(x_test, y_test)
)

model %>% fit(
  x_train, y_train, batch_size = 32, epochs = 200, validation_data = list(x_test, y_test), callbacks = list(
    callback_model_checkpoint("cifar-model.hdf5")
  )
)


```

